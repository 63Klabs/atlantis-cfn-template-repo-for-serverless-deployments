# Scripts Directory

This directory contains utility scripts for managing AWS CloudFormatio templates using a template and module S3 bucket.

## Prerequisites

Before using these scripts, ensure you have the following installed:

- Python 3.13+
- AWS CLI configured with appropriate credentials
- Required Python packages from `requirements.txt`

```bash
pip install -r requirements.txt
```

Make scripts executable:

```bash
chmod +x ./scripts/*.sh
chmod +x ./scripts/*.py
```

## Available Scripts

### upload_scripts.sh

Uploads script files to S3 with content-based change detection.

Usage:

```bash
# Basic usage
./upload_scripts.sh <bucket-name> <base-path>

# With custom source directory
./upload_scripts.sh <bucket-name> <base-path> <source-dir>

# With AWS profile
./upload_scripts.sh <bucket-name> <base-path> --profile <profile-name>

# Preview changes with dryrun
./upload_scripts.sh <bucket-name> <base-path> --dryrun
```

Example Output:

```text
Creating zip file from scripts...
  adding: scripts/requirements.txt (stored 0%)
  adding: scripts/s3_inventory.py (deflated 70%)
  adding: scripts/upload_scripts.sh (deflated 58%)
Local file hash: "903df56da392a3d7945a73f951cdff44"
Checking if file exists in S3...
Remote file hash: none
File has changed, uploading to S3...
Upload successful
Done!
```

### sync_templates.sh

Synchronizes template files with S3, maintaining exact timestamps and handling deletions.

Usage:

```bash
# Basic usage
./sync_templates.sh <bucket-name> <base-path>

# With custom source directory
./sync_templates.sh <bucket-name> <base-path> <source-dir>

# With AWS profile
./sync_templates.sh <bucket-name> <base-path> --profile <profile-name>

# Preview changes with dryrun
./sync_templates.sh <bucket-name> <base-path> --dryrun
```

Example Output:

```text
Using default AWS credentials
Syncing files from templates to s3://my-bucket/atlantis/utilities...
upload: templates/example.yaml to s3://my-bucket/atlantis/utilities/templates/example.yaml
upload: templates/config.json to s3://my-bucket/atlantis/utilities/templates/config.json
delete: s3://my-bucket/atlantis/utilities/templates/old-file.yml
Sync completed successfully
Done!
```

### s3_inventory.py

Generates an inventory of S3 objects and their metadata.

Usage:

```bash
# Basic usage
python s3_inventory.py --bucket <bucket-name> --prefix <prefix>

# With AWS profile
python s3_inventory.py --bucket <bucket-name> --prefix <prefix> --profile <profile-name>

# Save output to specific location
python s3_inventory.py --bucket <bucket-name> --prefix <prefix> --output ./outputs/inventory.json
```

Example Output:

```json
{
  "bucket": "XXXXXXXXX",
  "prefix": "atlantis/utilities",
  "objects": [
    {
      "key": "atlantis/utilities/templates/example.yaml",
      "size": 1234,
      "last_modified": "2024-01-20T15:30:00Z",
      "etag": "\"abc123def456\""
    },
    {
      "key": "atlantis/utilities/scripts/template_scripts.zip",
      "size": 5678,
      "last_modified": "2024-01-20T15:35:00Z",
      "etag": "\"xyz789\""
    }
  ]
}
```

## Common Options

All scripts support the following common options:

- `--profile`: Specify an AWS profile to use
- `--dryrun`: Preview changes without making them (s3_inventory.py does not support this as it does not modify S3)

## Error Handling

Scripts will exit with appropriate error messages for common issues:

- Missing AWS credentials
- Invalid parameters
- File/directory not found
- S3 access denied
- Network connectivity issues

## Requirements

See requirements.txt for Python package dependencies:

```text
boto3>=1.26.0
botocore>=1.29.0
```

## Notes

- All scripts use AWS credentials from either:
  - Default profile
  - Specified profile via `--profile`
  - Environment variables (`AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`)
- Scripts maintain consistent behavior across different operating systems
- File timestamps and checksums are used to minimize unnecessary uploads

This README and the scripts contained within this directory were generated by Amazon Q through iterative prompts and testing by the author to produce the desired results. 

Report any bugs or security issues via the [Atlantis template repository for serverless deployments using AWS SAM and CloudFormation](https://github.com/63klabs/atlantis-cfn-template-repo-for-serverless-deployments) repository.
